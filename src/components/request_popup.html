<div class="popup" id="popup">
  <div class="popup__content">
    <button id="closePopup" class="popup__close-btn popup__close"><span class="icon icon-close-lg"></span></button>
    <div class="popup__wrapper">
      <div class="popup__content-text">
        <h4 class="popup__title">Contact us</h4>
        <p class="p-1">
          Reaching out to us for a free consultation and let our creative experts bring your vision to life.
        </p>

        <div class="divider"></div>

        <ul class="contacts__list">
          <li class="contacts__item">
            <p class="p-3 contacts__label">Drop us a line</p>
            <div class="contacts__item-content">
              <span class="icon-sms icon"></span>
              <a id="email-address" class="p-1" href="mailto:hello@mfisher.agency">hello@mfisher.agency</a>
              <span id="email-copy" class="icon icon-copy icon_primary-green" onclick="copyEmail()"></span>
            </div>
          </li>
          <li class="contacts__item">
            <p class="p-3 contacts__label">Let’s have a quick call</p>
            <div class="contacts__item-content">
              <span class="icon icon-call"></span>
              <a id="phone-number" class="p-1" href="tel:+123455677">+ 1 234 55 677</a>
              <span id="phone-copy" class="icon icon-copy icon_primary-green" onclick="copyPhoneNumber()"></span>
            </div>
          </li>
          <li class="contacts__item">
            <p class="p-3 contacts__label">Meetup for a coffee</p>
            <div class="contacts__item-content">
              <span class="icon icon-location"></span>
              <p class="p-1">Warsaw, Poland</p>
            </div>
          </li>
        </ul>

        <ul class="social__list">
          <li class="social__item">
            <a href="https://dribbble.com" class="social__link" target="_blank">
              <span class="social__icon icon-dribbble"></span>
            </a>
          </li>
          <li class="social__item">
            <a href="https://behance.com" class="social__link" target="_blank">
              <span class="social__icon icon-behance"></span>
            </a>
          </li>
          <!--          <li class="social__item">-->
          <!--            <a href="https://facebook.com" class="social__link" target="_blank">-->
          <!--              <span class="social__icon icon-facebook"></span>-->
          <!--            </a>-->
          <!--          </li>-->
          <li class="social__item">
            <a href="https://linkedin.com" class="social__link" target="_blank">
              <span class="social__icon icon-linkedin"></span>
            </a>
          </li>
        </ul>
      </div>
      <div class="popup__content-form">
        <h4>Request Free Consultation</h4>
        <form id="order-form" name="order-form" class="form order-form" novalidate autocomplete="off">
          <div class="input-field">
            <div class="input-field-box">
              <input
                class="form-input validate"
                name="user-name"
                type="text"
                id="user-name"
                placeholder="Your Name*"
                pattern="^[a-zA-Zа-яА-ЯЁё \-]+$"
                data-error-message="Invalid format"
                aria-describedby="name-error"
                required
              />
              <span class="icon-user-tag icon"></span>
            </div>
            <span class="p-4 form__error name-error" id="user-name-error" aria-live="polite"> </span>
          </div>

          <div class="input-field">
            <div class="input-field-box">
              <input
                class="form-input validate"
                name="user-email"
                type="email"
                id="user-email"
                placeholder="Email*"
                data-error-message="Invalid E-mail"
                aria-describedby="email-error"
                required
              />
              <span class="icon-sms icon"></span>
            </div>
            <span class="p-4 form__error email-error" id="user-email-error" aria-live="polite"></span>
          </div>

          <div class="input-field">
            <div class="input-field-box">
              <input
                class="form-input validate"
                name="user-phone"
                type="text"
                id="user-phone"
                data-error-message="Invalid format"
                aria-describedby="phone-error"
              />
            </div>
            <span class="p-4 form__error phone-error" id="user-phone-error" aria-live="polite"></span>
          </div>

          <div class="input-field">
            <textarea
              class="user-comment validate"
              name="user-comment"
              rows="4"
              minlength="50"
              id="user-comment"
              placeholder="Describe your industry and IT project*"
              data-error-message="min 50 characters"
              required
            ></textarea>
            <div class="counter" id="char-counter">0/50</div>
            <span class="p-4 form__error comment-error" id="user-comment-error" aria-live="polite"></span>
          </div>
          <div class="input-field">
            <label for="budget">Project budget:</label>
            <div class="budget-container" id="budget">
              <div class="budget-option p-2 selected" data-value="not-sure">Not Sure</div>
              <div class="budget-option p-2" data-value="<5k">&lt;$5K</div>
              <div class="budget-option p-2" data-value="5k-15k">$5K-$15K</div>
              <div class="budget-option p-2" data-value="15k-25k">$15K-$25</div>
              <div class="budget-option p-2" data-value=">30k">&gt;$30K</div>
            </div>
          </div>

          <ul id="file-list" class="file__list"></ul>

          <div class="check-box">
            <div class="accept-box">
              <input class="input-nda visually-hidden" type="checkbox" id="user-nda" name="user-nda" value="true" />
              <label class="label-accept" for="user-nda">
                <span class="label-accept-span icon icon-accept"> </span>
                <span class="p-2">I want to protect my data by signing an NDA.</span>
              </label>
            </div>
            <div class="tooltip__container">
              <span class="icon-info"></span>
              <div class="tooltip">
                <span class="p-4"
                  >Before we discuss any details about your project you can request to sign a Non Disclosure
                  Agreement</span
                >
              </div>
            </div>
          </div>

          <span class="p-4 form__empty-error" id="empty-error" aria-live="assertive"></span>

          <div class="form__footer">
            <div class="form__footer-action">
              <button class="btn_submit btn btn_primary" type="submit">
                <span class="btn__text">Send Request</span>
                <span class="btn__icon icon-arrow-right"> </span>
              </button>
              <label for="file-upload" class="btn_attach btn btn_secondary-black">
                <span class="btn__icon">
                  <span class="icon-attach"></span>
                </span>
                <span class="btn__text">Attach File</span>
              </label>
              <input type="file" id="file-upload" name="files" style="display: none" multiple />
            </div>
            <span class="p-5"
              >*No more than 3 files may be attached up to 30 MB each. Formats doc, docx, pdf, ppt, pptx, xlsx, zip,
              rar.</span
            >
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import emailjs from "@emailjs/browser";
  document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".hero__btn, .team__btn, .cta__btn, .accordion__btn, .process__btn");
    const popup = document.getElementById("popup");
    const closePopup = popup.querySelector(".popup__close");
    const form = document.querySelector(".order-form");
    const budgetOptions = document.querySelectorAll(".budget-option");
    const errorContainer = document.getElementById("empty-error");
    const fileInput = document.getElementById("file-upload");
    const fileList = document.getElementById("file-list");
    const uploadedFiles = new Set();

    const resetErrors = () => {
      const fields = form.querySelectorAll(".validate");
      fields.forEach((field) => {
        field.classList.remove("field-error");
        const errorSpan = document.querySelector(`#${field.id}-error`);
        if (errorSpan) errorSpan.textContent = "";
      });
      if (errorContainer) errorContainer.textContent = "";
    };

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        popup.classList.add("is-open");
        document.querySelector("html").classList.add("no-scroll");
      });
    });

    closePopup.addEventListener("click", () => {
      form.reset();
      fileList.innerHTML = "";
      budgetOptions.forEach((option) => option.classList.remove("selected"));
      uploadedFiles.clear();
      popup.classList.remove("is-open");
      document.querySelector("html").classList.remove("no-scroll");
      resetErrors();
    });

    popup.addEventListener("click", (event) => {
      if (event.target === popup) {
        form.reset();
        fileList.innerHTML = "";
        budgetOptions.forEach((option) => option.classList.remove("selected"));
        uploadedFiles.clear();
        popup.classList.remove("is-open");
        document.querySelector("html").classList.remove("no-scroll");
        resetErrors();
      }
    });

    const validateEmail = (email) => {
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(email)) return false;

      const domain = email.split("@")[1];
      const domainParts = domain.split(".");
      if (domainParts.length < 2) return false;

      const tld = domainParts[domainParts.length - 1];
      return tld.length >= 2;
    };

    const validateField = (field) => {
      const errorSpan = document.querySelector(`#${field.id}-error`);
      if (field.type === "email") {
        if (!validateEmail(field.value)) {
          errorSpan.textContent = "Invalid E-mail";
          return false;
        }
      } else if (!field.checkValidity()) {
        const errorMessage = field.getAttribute("data-error-message") || "Invalid field.";
        errorSpan.textContent = errorMessage;
        return false;
      } else {
        errorSpan.textContent = "";
      }
      return true;
    };

    const validateFiles = () => {
      const files = fileInput.files;
      const allowedExtensions = ["doc", "docx", "pdf", "ppt", "pptx", "xlsx", "zip", "rar"];
      const maxFileSize = 30 * 1024 * 1024; // 30MB
      const maxFiles = 3;

      if (!errorContainer) return false;

      for (let file of files) {
        const extension = file.name.split(".").pop().toLowerCase();

        if (uploadedFiles.has(file.name)) {
          errorContainer.textContent = `File ${file.name} is already added.`;
          continue;
        }

        if (!allowedExtensions.includes(extension)) {
          errorContainer.textContent = `Unsupported file format: ${file.name}`;
          return false;
        }

        if (file.size > maxFileSize) {
          errorContainer.textContent = `File ${file.name} exceeds the 30MB size limit.`;
          return false;
        }

        if (uploadedFiles.size >= maxFiles) {
          errorContainer.textContent = `You can attach up to ${maxFiles} files.`;
          return false;
        }

        const listItem = document.createElement("li");
        listItem.classList.add("file__item");

        const fileName = document.createElement("span");
        fileName.textContent = file.name;

        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = '<span class="icon icon-close"></span>';
        deleteButton.classList.add("btn-del");
        deleteButton.addEventListener("click", () => {
          listItem.remove();
          uploadedFiles.delete(file.name);
          errorContainer.textContent = "";
        });

        listItem.appendChild(fileName);
        listItem.appendChild(deleteButton);
        fileList.appendChild(listItem);
        uploadedFiles.add(file.name);
      }

      errorContainer.textContent = "";
      return true;
    };

    const validateForm = () => {
      let isValid = true;
      const fields = form.querySelectorAll(".validate");

      fields.forEach((field) => {
        if (field.id && !validateField(field)) {
          isValid = false;
          field.classList.add("field-error");
        } else {
          field.classList.remove("field-error");
        }
      });

      if (!validateFiles()) {
        isValid = false;
      }

      return isValid;
    };

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      if (validateForm()) {
        errorContainer.textContent = "";
        const formData = new FormData(form);

        emailjs.init("lLSKvVcx1LQ3lQ7Qy");

        const data = {
          user_name: formData.get("user-name"),
          user_email: formData.get("user-email"),
          user_phone: formData.get("user-phone"),
          user_comment: formData.get("user-comment"),
          project_budget:
            document.querySelector(".budget-option.selected")?.getAttribute("data-value") || "Not specified",
          user_nda: formData.get("user-nda") ? "Yes" : "No",
        };

        emailjs
          .send("service_d3x1f1d", "template_9nakrge", data)
          .then(() => {
            const popupMini = document.getElementById("popup-mini");
            popupMini.classList.remove("hide");
            popupMini.classList.add("is-open");

            popupMini.querySelector(".popup-mini__close-btn").addEventListener("click", () => {
              popupMini.classList.remove("is-open");
              popupMini.classList.add("hide");

              form.reset();
              fileList.innerHTML = "";
              budgetOptions.forEach((option) => option.classList.remove("selected"));
              uploadedFiles.clear();
              resetErrors();
            });
          })
          .catch((error) => {
            console.error("Error submitting form:", error);
            alert("There was an error submitting the form.");
          });
      } else {
        errorContainer.textContent = "Please fix the errors above before submitting.";
      }
    });

    fileInput.addEventListener("change", validateFiles);
  });
</script>
